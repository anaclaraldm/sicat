{% extends "aluno/aluno.html" %}

{% block title %}Aluno - Marcar Tutoria{% endblock %}

{% block titulo_sessao %}
Marcar uma sess√£o de tutoria
{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <form action="{{ url_for('aluno_marcar') }}" method="POST" class="bg-white border-2 border-blue-900 rounded-[32px] p-8 shadow-md max-w-4xl mx-auto">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block font-medium mb-2 text-gray-700">Disciplina:</label>
                <select id="filtro_disciplina" class="w-full px-4 py-3 rounded-full bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none">
                    <option value="">Todas as mat√©rias</option>
                    {% for d in disciplinas %}
                        <option value="{{ d.id }}">{{ d.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block font-medium mb-2 text-gray-700">Turno:</label>
                <select id="filtro_turno" class="w-full px-4 py-3 rounded-full bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none">
                    <option value="">Todos os turnos</option>
                    <option value="Matutino">Matutino</option>
                    <option value="Vespertino">Vespertino</option>
                    <option value="Noturno">Noturno</option>
                </select>
            </div>
        </div>

        <button type="button" onclick="pesquisarSessoes()" class="mb-8 bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-3 rounded-full transition-all">
            Pesquisar Tutoria
        </button>

        <div id="sessao_container" class="hidden border-t pt-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-4">Selecione o Hor√°rio Dispon√≠vel:</h3>
            
            <select id="id_sessao" name="id_sessao" class="w-full px-4 py-3 rounded-full bg-blue-50 border-2 border-blue-200 mb-8 outline-none focus:border-blue-500">
                </select>

            <div class="flex justify-end">
                <button type="submit" class="px-10 py-4 rounded-full text-white font-bold bg-gradient-to-r from-pink-600 to-blue-800 hover:scale-105 transition-transform shadow-lg">
                    Confirmar Agendamento
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    // Recebe os dados do Python convertidos para JSON
    const sessoesBanco = JSON.parse('{{ sessoes_js | tojson | safe }}');

    function pesquisarSessoes() {
        const discId = document.getElementById("filtro_disciplina").value;
        const turno = document.getElementById("filtro_turno").value;
        const selectSessao = document.getElementById("id_sessao");
        const container = document.getElementById("sessao_container");

        // Limpa a lista anterior antes de filtrar
        selectSessao.innerHTML = "";

        // Filtra as sess√µes baseadas na Disciplina E no Turno
        const filtradas = sessoesBanco.filter(s => {
            const bateDisciplina = !discId || s.disciplina_id == discId;
            const bateTurno = !turno || s.turno === turno;
            return bateDisciplina && bateTurno;
        });

        if (filtradas.length > 0) {
            filtradas.forEach(s => {
                const option = document.createElement("option");
                // Define o ID da sess√£o como o valor a ser enviado para o banco
                option.value = s.id; 
                option.textContent = `üìÖ ${s.data} √†s ${s.horario} - Tutor: ${s.tutor_nome}`;
                selectSessao.appendChild(option);
            });
            container.classList.remove("hidden");
        } else {
            alert("Nenhuma sess√£o dispon√≠vel para os filtros selecionados.");
            container.classList.add("hidden");
        }
    }
</script>
{% endblock %}