{% extends "aluno/aluno.html" %}

{% block title %}Aluno - Marcar Tutoria{% endblock %}

{% block titulo_sessao %}
Marcar uma sessão de tutoria
{% endblock %}

{% block content %}
<form action="{{ url_for('aluno_marcar') }}" method="POST" class="bg-white border-2 border-blue-900 rounded-[32px] p-8 shadow-md max-w-4xl">
    
    <div class="mb-6">
        <label class="block font-medium mb-2">Selecione a disciplina:</label>
        <select id="id_disciplina" name="id_disciplina" onchange="filtrarSessoes()"
                class="w-full px-4 py-3 rounded-full bg-gray-100 focus:outline-none">
            <option value="">Selecione uma matéria</option>
            {% for d in disciplinas %}
                <option value="{{ d.id }}">{{ d.nome }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="sessao_container" class="hidden mt-6">
        <h3 class="text-lg font-semibold text-blue-600 mb-4">Horários Disponíveis</h3>
        <select id="id_sessao" name="id_sessao" 
                class="w-full px-4 py-3 rounded-full bg-gray-100 mb-6">
        </select>

        <div class="flex justify-end">
            <button type="submit" class="px-8 py-3 rounded-full text-white font-semibold
                           bg-gradient-to-r from-pink-600 to-blue-800">
                Confirmar Agendamento
            </button>
        </div>
    </div>
</form>

<script>
    // Recebe a lista processada pela rota
    const sessoesBanco = {{ sessoes_js | tojson }};

    function filtrarSessoes() {
        const disciplinaId = document.getElementById("id_disciplina").value;
        const selectSessao = document.getElementById("id_sessao");
        const container = document.getElementById("sessao_container");
        
        selectSessao.innerHTML = ""; 

        if (!disciplinaId) {
            container.classList.add("hidden");
            return;
        }

        const filtradas = sessoesBanco.filter(s => s.disciplina_id == disciplinaId);

        if (filtradas.length > 0) {
            container.classList.remove("hidden");
            selectSessao.innerHTML = "<option value=''>Escolha um horário e tutor</option>";
            
            filtradas.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.id;
                opt.textContent = `${s.data} às ${s.horario} - Tutor: ${s.tutor}`;
                selectSessao.appendChild(opt);
            });
        } else {
            container.classList.remove("hidden");
            selectSessao.innerHTML = "<option value=''>Nenhuma sessão disponível para esta matéria</option>";
        }
    }
</script>
{% endblock %}